<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - VideoT</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <h1>Login / Registo</h1>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Palavra-passe">
    <button id="login-btn" type="button">Iniciar sessão</button>
    <button id="register-btn" type="button">Registar</button>
    <button id="login-google-btn" type="button">Entrar com Google</button>
    <p id="auth-status"></p>

    <script>
        // ==========================================================
        // 🔧 CONFIGURAÇÃO FIREBASE
        // ==========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBI_4n8aBT9ZPiLy8cwgiQDtD0_CYSKk4E",
            authDomain: "videot-2fcec.firebaseapp.com",
            projectId: "videot-2fcec",
            storageBucket: "videot-2fcec.appspot.com",
            messagingSenderId: "583396995831",
            appId: "1:583396995831:web:6182575e28ea628cc259f2"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth();
        const db = app.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const loginGoogleBtn = document.getElementById('login-google-btn');
        const authStatus = document.getElementById('auth-status');

        // ==========================================================
        // 🔒 PERSISTÊNCIA DE SESSÃO
        // ==========================================================
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e => console.warn("Aviso persistência:", e));

        // ==========================================================
        // 💾 GUARDAR OU ATUALIZAR DADOS DO UTILIZADOR
        // ==========================================================
        async function saveOrUpdateUser(user) {
            const username = user.displayName ? user.displayName.split(' ')[0] : user.email.split('@')[0];
            const userRef = db.collection('users').doc(user.uid);
            const doc = await userRef.get();
            if (!doc.exists) {
                await userRef.set({
                    email: user.email,
                    username: username,
                    profilePic: user.photoURL || `https://i.pravatar.cc/150?u=${user.uid}`,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }

        // ==========================================================
        // 🧭 REDIRECIONAMENTO AUTOMÁTICO SE JÁ ESTIVER AUTENTICADO
        // ==========================================================
        auth.onAuthStateChanged(user => {
            console.log("onAuthStateChanged:", user);
            if (user) {
                window.location.replace("index.html");
            }
        });

        // ==========================================================
        // 🔹 LOGIN COM GOOGLE
        // ==========================================================
        async function handleGoogleLogin() {
            authStatus.textContent = "A iniciar sessão com Google...";
            try {
                const result = await auth.signInWithPopup(googleProvider);
                await saveOrUpdateUser(result.user);
                window.location.replace("index.html");
            } catch (error) {
                console.error("Erro Google Login:", error);
                authStatus.textContent = `Erro: ${error.message}`;
            }
        }

        // ==========================================================
        // 🔹 LOGIN OU REGISTO COM EMAIL
        // ==========================================================
        async function handleEmailPasswordLogin(isRegister) {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            if (!email || password.length < 6) {
                authStatus.textContent = "Email ou palavra-passe inválidos (mínimo 6 caracteres).";
                return;
            }
            try {
                if (isRegister) {
                    authStatus.textContent = "A criar conta...";
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await saveOrUpdateUser(userCredential.user);
                } else {
                    authStatus.textContent = "A iniciar sessão...";
                    await auth.signInWithEmailAndPassword(email, password);
                }
                window.location.replace("index.html");
            } catch (error) {
                console.error("Erro auth:", error);
                authStatus.textContent = `Erro: ${error.message}`;
            }
        }

        // ==========================================================
        // 🔘 EVENT LISTENERS
        // ==========================================================
        loginGoogleBtn.addEventListener("click", handleGoogleLogin);
        loginBtn.addEventListener("click", () => handleEmailPasswordLogin(false));
        registerBtn.addEventListener("click", () => handleEmailPasswordLogin(true));
    </script>
</body>
</html>
