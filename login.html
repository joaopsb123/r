<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VideoT - Login</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
  <div id="login-container">
    <h1>🎥 VideoT</h1>
    <h3>Entrar ou criar conta</h3>

    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Palavra-passe" />

    <button id="login-btn">Entrar</button>
    <button id="register-btn">Registar</button>
    <button id="google-btn">Entrar com Google</button>

    <p id="auth-status"></p>
  </div>

  <script>
    // ======================================================
    // 🔧 CONFIGURAÇÃO FIREBASE
    // ======================================================
    const firebaseConfig = {
      apiKey: "AIzaSyBI_4n8aBT9ZPiLy8cwgiQDtD0_CYSKk4E",
      authDomain: "videot-2fcec.firebaseapp.com",
      projectId: "videot-2fcec",
      storageBucket: "videot-2fcec.appspot.com",
      messagingSenderId: "583396995831",
      appId: "1:583396995831:web:6182575e28ea628cc259f2",
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = app.auth();
    const db = app.firestore();
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("login-btn");
    const registerBtn = document.getElementById("register-btn");
    const googleBtn = document.getElementById("google-btn");
    const authStatus = document.getElementById("auth-status");

    // ======================================================
    // 💾 GUARDAR DADOS DO UTILIZADOR NO FIRESTORE
    // ======================================================
    async function saveUserData(user) {
      const username = user.displayName
        ? user.displayName.split(" ")[0]
        : user.email.split("@")[0];

      const userRef = db.collection("users").doc(user.uid);
      const doc = await userRef.get();
      if (!doc.exists) {
        await userRef.set({
          email: user.email,
          username,
          profilePic:
            user.photoURL || `https://i.pravatar.cc/150?u=${user.uid}`,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
      }
    }

    // ======================================================
    // 🔒 LOGIN E REGISTO
    // ======================================================
    loginBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || password.length < 6) {
        authStatus.textContent = "⚠️ Email ou palavra-passe inválidos.";
        return;
      }
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        authStatus.textContent = "❌ " + error.message;
      }
    });

    registerBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || password.length < 6) {
        authStatus.textContent = "⚠️ Email ou palavra-passe inválidos.";
        return;
      }
      try {
        const result = await auth.createUserWithEmailAndPassword(
          email,
          password
        );
        await saveUserData(result.user);
      } catch (error) {
        authStatus.textContent = "❌ " + error.message;
      }
    });

    googleBtn.addEventListener("click", async () => {
      try {
        const result = await auth.signInWithPopup(googleProvider);
        await saveUserData(result.user);
      } catch (error) {
        authStatus.textContent = "❌ " + error.message;
      }
    });

    // ======================================================
    // 🧭 REDIRECIONAR SE ESTIVER LOGADO
    // ======================================================
    auth.onAuthStateChanged((user) => {
      if (user) window.location.href = "index.html";
    });
  </script>
</body>
</html>
